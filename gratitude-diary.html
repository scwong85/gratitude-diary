<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gratitude Diary</title>
  <meta name="description" content="Offline gratitude diary with streak tracking and photo attachments" />
  <meta name="theme-color" content="#8ecae6" />

  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR3JhdGl0dWRlIERpYXJ5Iiwic2hvcnRfbmFtZSI6IkdyYXRpdHVkZSIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjOGVjYWU2IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB3aWR0aD0nMTkyJyBoZWlnaHQ9JzE5Micgdmlld0JveD0nMCAwIDE5MiAxOTInJTNFJTNDcmVjdCBmaWxsPSclMjM4ZWNhZTYnIHdpZHRoPScxOTInIGhlaWdodD0nMTkyJy8lM0UlM0N0ZXh0IHg9Jzk2JyB5PScxMjAnIGZvbnQtc2l6ZT0nODAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZpbGw9J3doaXRlJyUzRSVFMiU5QyVBOCUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==" />

  <style>
    :root {
      var(--sky): #8ecae6;
      --sky: #8ecae6;
      --mint: #b8f2e6;
      --lavender: #cdb4db;
      --peach: #ffd6a5;
      --pink: #ffafcc;
      --lemon: #fdffb6;

      --bg: #fbfbff;
      --card: rgba(255, 255, 255, 0.9);
      --ink: #263238;
      --muted: #607d8b;
      --border: rgba(38, 50, 56, 0.12);
      --shadow: rgba(38, 50, 56, 0.12);

      --radius-lg: 20px;
      --radius-md: 14px;
      --radius-sm: 10px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, var(--mint), transparent 60%),
                  radial-gradient(1000px 600px at 80% 10%, var(--lavender), transparent 60%),
                  linear-gradient(180deg, #ffffff, #f7fbff);
      color: var(--ink);
      min-height: 100vh;
      padding-bottom: 92px;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }

    .topbar-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: 1.05rem;
    }

    .brand-badge {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--sky), var(--pink));
      display: grid;
      place-items: center;
      color: white;
      box-shadow: 0 10px 22px rgba(142, 202, 230, 0.35);
    }

    .hamburger {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      display: grid;
      place-items: center;
    }

    .hamburger:active { transform: scale(0.98); }

    .hamburger-lines { width: 18px; height: 14px; position: relative; }
    .hamburger-lines span {
      position: absolute;
      left: 0; right: 0; height: 2px;
      border-radius: 10px;
      background: var(--ink);
      opacity: 0.9;
    }
    .hamburger-lines span:nth-child(1) { top: 1px; }
    .hamburger-lines span:nth-child(2) { top: 6px; }
    .hamburger-lines span:nth-child(3) { top: 11px; }

    .drawer-backdrop {
      position: fixed; inset: 0;
      background: rgba(0, 0, 0, 0.35);
      z-index: 150;
      display: none;
    }
    .drawer-backdrop.open { display: block; }

    .drawer {
      position: fixed;
      top: 0; right: 0;
      height: 100vh;
      width: min(88vw, 330px);
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(10px);
      border-left: 1px solid var(--border);
      box-shadow: -20px 0 50px rgba(0,0,0,0.18);
      transform: translateX(102%);
      transition: transform 0.25s ease;
      z-index: 200;
      padding: 18px;
      display: flex; flex-direction: column; gap: 14px;
    }
    .drawer.open { transform: translateX(0); }

    .drawer-top {
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    .drawer-title { font-weight: 800; }
    .drawer-close {
      width: 40px; height: 40px;
      border-radius: 14px; border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.8);
      cursor: pointer; font-size: 1.2rem; line-height: 1;
    }

    .drawer-stats {
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 14px;
      background: linear-gradient(135deg, rgba(142, 202, 230, 0.25), rgba(255, 175, 204, 0.20));
    }
    .drawer-stats-row {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      margin-top: 10px; color: var(--muted); font-size: 0.95rem;
    }
    .drawer-streak { font-size: 1.8rem; font-weight: 900; color: var(--ink); }

    .drawer-nav { display: flex; flex-direction: column; gap: 8px; margin-top: 6px; }
    .drawer-nav button {
      width: 100%; text-align: left; padding: 12px 12px;
      border-radius: 14px; border: 1px solid var(--border);
      background: rgba(255,255,255,0.75); cursor: pointer; font-size: 1rem;
    }
    .drawer-nav button.active {
      border-color: rgba(142, 202, 230, 0.8);
      box-shadow: 0 12px 26px rgba(142, 202, 230, 0.18);
      background: linear-gradient(135deg, rgba(142, 202, 230, 0.22), rgba(184, 242, 230, 0.18));
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 18px 14px; }

    .view { display: none; }
    .view.active { display: block; }

    .cards {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 12px; margin: 14px 0 18px;
    }

    .card {
      border-radius: var(--radius-lg); padding: 14px;
      background: var(--card); border: 1px solid var(--border);
      box-shadow: 0 12px 26px var(--shadow);
    }

    .card.clickable {
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .card.clickable:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(38, 50, 56, 0.15);
      border-color: rgba(142, 202, 230, 0.5);
    }

    .card .value {
      font-size: 1.9rem; font-weight: 900;
      background: linear-gradient(135deg, var(--sky), var(--pink));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .card .label { color: var(--muted); margin-top: 4px; font-size: 0.95rem; }

    .calendar-shell {
      border-radius: var(--radius-lg); background: var(--card);
      border: 1px solid var(--border); box-shadow: 0 14px 34px rgba(38, 50, 56, 0.10);
      overflow: hidden;
      position: relative; 
      touch-action: pan-y; 
    }
    .calendar-top {
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
      padding: 14px 14px; background: linear-gradient(135deg, rgba(253, 255, 182, 0.35), rgba(255, 214, 165, 0.25));
      border-bottom: 1px solid var(--border);
    }
    .month-title { font-size: 1.15rem; font-weight: 900; letter-spacing: 0.2px; }
    .month-btn {
      border: 1px solid var(--border); background: rgba(255,255,255,0.9);
      padding: 10px 12px; border-radius: 14px; cursor: pointer; font-weight: 700;
    }
    .calendar-grid {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 14px;
      transition: transform 0.25s ease-out, opacity 0.2s ease-out; 
    }
    .cal-head {
      text-align: center; font-weight: 800; color: var(--muted); font-size: 0.9rem; padding: 6px 0 8px; display: none;
    }
    .cal-day {
      min-height: 92px; border-radius: 18px; border: 1px solid var(--border);
      background: rgba(255,255,255,0.8); padding: 10px; cursor: pointer;
      display: flex; flex-direction: column; gap: 6px;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      position: relative; overflow: hidden;
    }
    .cal-day:hover {
      transform: translateY(-2px); box-shadow: 0 14px 28px rgba(38, 50, 56, 0.12);
    }
    .cal-day.blank { border-color: transparent; background: transparent; cursor: default; box-shadow: none; display:none;}
    .cal-day.today {
      border-color: rgba(142, 202, 230, 0.9); box-shadow: 0 12px 24px rgba(142, 202, 230, 0.18);
    }
    .cal-day.has-entry {
      background: linear-gradient(135deg, rgba(255, 175, 204, 0.22), rgba(253, 255, 182, 0.22));
      border-color: rgba(255, 175, 204, 0.55);
    }
    .cal-day-top { display: flex; align-items: baseline; justify-content: space-between; gap: 8px; }
    .day-num { font-weight: 900; font-size: 1.05rem; }
    .mood { font-size: 1.2rem; }
    .thumb {
      width: 100%; height: 48px; border-radius: 14px; object-fit: cover;
      border: 1px solid rgba(0,0,0,0.05); background: rgba(0,0,0,0.04);
    }
    .entry-snippet {
      font-size: 0.78rem; color: rgba(38, 50, 56, 0.80); line-height: 1.25;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden; min-height: 0;
    }

    .search {
      width: 100%; padding: 12px 14px; border-radius: 16px; border: 1px solid var(--border);
      background: rgba(255,255,255,0.9); font-size: 1rem; margin-bottom: 12px;
    }
    .entry-card {
      border-radius: var(--radius-lg); background: var(--card); border: 1px solid var(--border);
      padding: 14px; box-shadow: 0 12px 26px rgba(38, 50, 56, 0.10); margin-bottom: 12px;
    }
    .entry-head {
      display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px;
    }
    .entry-date { font-weight: 900; color: #284b63; }
    .icon-btn {
      border: 1px solid var(--border); background: rgba(255,255,255,0.8);
      padding: 8px 10px; border-radius: 14px; cursor: pointer; font-size: 1rem;
    }
    .entry-text { line-height: 1.55; color: rgba(38, 50, 56, 0.92); white-space: pre-wrap; }
    .entry-photo {
      width: 100%; border-radius: 18px; margin-top: 10px; object-fit: cover;
      max-height: 360px; border: 1px solid rgba(0,0,0,0.06);
    }

    .modal {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.55); z-index: 300; padding: 16px;
    }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content {
      width: 100%; max-width: 720px; max-height: 92vh; overflow-y: auto;
      background: rgba(255,255,255,0.94); border: 1px solid var(--border);
      border-radius: 26px; box-shadow: 0 25px 70px rgba(0,0,0,0.28);
    }
    .modal-head {
      padding: 16px 16px 10px; display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    .modal-head h2 { font-size: 1.15rem; font-weight: 950; }
    .modal-close {
      width: 44px; height: 44px; border-radius: 16px; border: 1px solid var(--border);
      background: rgba(255,255,255,0.9); cursor: pointer; font-size: 1.35rem; line-height: 1;
    }
    .modal-body { padding: 0 16px 16px; }
    .section {
      border: 1px solid var(--border); background: rgba(255,255,255,0.9);
      border-radius: 20px; padding: 14px; margin-top: 12px;
    }
    .section-title { font-weight: 900; margin-bottom: 10px; color: rgba(38, 50, 56, 0.92); }
    textarea {
      width: 100%; min-height: 160px; border-radius: 18px; border: 1px solid var(--border);
      padding: 12px; font-size: 1rem; font-family: inherit; background: rgba(255,255,255,0.98);
      resize: vertical; outline: none;
    }
    textarea:focus {
      border-color: rgba(142, 202, 230, 0.9); box-shadow: 0 0 0 4px rgba(142, 202, 230, 0.18);
    }
    .moods { display: flex; flex-wrap: wrap; gap: 8px; }
    .mood-btn {
      font-size: 1.35rem; border-radius: 16px; padding: 10px 12px;
      border: 1px solid var(--border); background: rgba(255,255,255,0.95);
      cursor: pointer; transition: transform 0.12s ease;
    }
    .mood-btn.selected {
      border-color: rgba(255, 175, 204, 0.85); box-shadow: 0 12px 24px rgba(255, 175, 204, 0.18);
      transform: translateY(-1px); background: linear-gradient(135deg, rgba(255, 175, 204, 0.18), rgba(253, 255, 182, 0.18));
    }
    .prompts { display: grid; gap: 8px; }
    .prompt {
      border: 1px solid var(--border); background: rgba(255,255,255,0.95);
      padding: 10px 12px; border-radius: 16px; cursor: pointer; color: rgba(38, 50, 56, 0.90);
    }
    .prompt:hover { border-color: rgba(142, 202, 230, 0.85); }

    .photo-row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .photo-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      border: 1px solid var(--border); background: rgba(255,255,255,0.92);
      padding: 12px 14px; border-radius: 18px; cursor: pointer; font-weight: 900;
    }
    .btn.primary {
      border-color: rgba(142, 202, 230, 0.85); background: linear-gradient(135deg, rgba(142, 202, 230, 0.25), rgba(184, 242, 230, 0.18));
    }
    .btn.danger {
      border-color: rgba(255, 99, 132, 0.50); background: linear-gradient(135deg, rgba(255, 99, 132, 0.10), rgba(255, 175, 204, 0.14));
    }
    .photo-preview {
      width: 100%; border-radius: 22px; border: 1px solid rgba(0,0,0,0.06);
      max-height: 380px; object-fit: cover; display: none; background: rgba(0,0,0,0.03);
    }
    .empty { text-align: center; color: var(--muted); padding: 30px 10px; }

    .fab {
      position: fixed; right: 18px; bottom: 18px; width: 60px; height: 60px;
      border-radius: 22px; border: 1px solid rgba(255,255,255,0.55);
      background: linear-gradient(135deg, var(--sky), var(--pink)); color: white;
      font-size: 2rem; font-weight: 900; cursor: pointer;
      box-shadow: 0 18px 40px rgba(255, 175, 204, 0.30); z-index: 120;
    }
    .fab:active { transform: translateY(1px); }

    @media (max-width: 860px) {
      .calendar-grid { gap: 8px; }
      .cal-day { min-height: 84px; padding: 9px; border-radius: 16px; }
      .thumb { height: 42px; border-radius: 12px; }
    }
    @media (max-width: 520px) {
      .cal-head { font-size: 0.82rem; }
      .cal-day { min-height: 74px; padding: 8px; }
      .day-num { font-size: 0.98rem; }
      .entry-snippet { display: none; }
      .thumb { height: 38px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-badge">‚ú®</div>
        <div>Gratitude Diary</div>
      </div>

      <button class="hamburger" id="menuBtn" aria-label="Open menu">
        <div class="hamburger-lines" aria-hidden="true">
          <span></span><span></span><span></span>
        </div>
      </button>
    </div>
  </div>

  <div class="drawer-backdrop" id="drawerBackdrop"></div>

  <aside class="drawer" id="drawer" aria-label="Menu">
    <div class="drawer-top">
      <div class="drawer-title">Menu</div>
      <button class="drawer-close" id="drawerClose" aria-label="Close menu">√ó</button>
    </div>

    <div class="drawer-stats">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div style="font-weight:900;">üî• Current streak</div>
        <div class="drawer-streak" id="drawerStreak">0</div>
      </div>
      <div class="drawer-stats-row">
        <div>Total entries</div>
        <div id="drawerTotal">0</div>
      </div>
    </div>

    <nav class="drawer-nav">
      <button class="active" data-view="home">üìÖ Calendar</button>
      <button data-view="entries">üìñ Entries</button>
      <button data-view="stats">üìä Stats</button>
      <button data-view="settings">‚öôÔ∏è Data</button>
    </nav>

    <div style="margin-top:auto; color:var(--muted); font-size:0.9rem;">
      Offline-first. Export your data regularly.
    </div>
  </aside>

  <main class="container">
    <!-- HOME -->
    <section class="view active" id="home">
      <div class="cards">
        <div class="card">
          <div class="value" id="currentStreak">0</div>
          <div class="label">Current streak</div>
        </div>
        <div class="card clickable" id="totalEntriesCard" title="View all entries">
          <div class="value" id="totalEntries">0</div>
          <div class="label">Total entries ‚Üó</div>
        </div>
        <div class="card">
          <div class="value" id="longestStreak">0</div>
          <div class="label">Longest streak</div>
        </div>
      </div>

      <div id="milestoneContainer"></div>

      <div class="calendar-shell">
        <div class="calendar-top">
          <button class="month-btn" id="prevMonth">‚Üê Prev</button>
          <div class="month-title" id="currentMonth">Month Year</div>
          <button class="month-btn" id="nextMonth">Next ‚Üí</button>
        </div>

        <div class="calendar-grid" id="calendarGrid">
          <!-- headers + days injected -->
        </div>
      </div>
    </section>

    <!-- ENTRIES -->
    <section class="view" id="entries">
      <input class="search" id="searchBox" type="text" placeholder="Search entries..." />
      <div id="entriesList"></div>
    </section>

    <!-- STATS -->
    <section class="view" id="stats">
      <div class="cards">
        <div class="card">
          <div class="value" id="thisMonthEntries">0</div>
          <div class="label">This month</div>
        </div>
        <div class="card">
          <div class="value" id="photoCount">0</div>
          <div class="label">Photos added</div>
        </div>
        <div class="card">
          <div class="value" id="favoritesCount">0</div>
          <div class="label">Favorites</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div style="font-weight:900; margin-bottom:10px;">On this day</div>
        <div id="onThisDay" style="color:var(--muted);"></div>
      </div>
    </section>

    <!-- SETTINGS (DATA) -->
    <section class="view" id="settings">
      <div class="card">
        <div style="font-weight:900; margin-bottom:10px;">Import / Export</div>
        <button class="btn primary" id="exportBtn" style="width:100%; margin-bottom:10px;">üì§ Export all data (ZIP)</button>
        <button class="btn" id="importBtn" style="width:100%;">üì• Import data (ZIP)</button>
        <input type="file" id="importFile" accept=".zip" style="display:none;" />
      </div>

      <div class="card" style="margin-top:12px;">
        <div style="font-weight:900; margin-bottom:10px;">About</div>
        <div style="color:var(--muted); line-height:1.55;">
          A simple offline gratitude diary with streaks, mood tags, one photo per day, and export/import.
        </div>
      </div>
    </section>
  </main>

  <!-- ENTRY MODAL -->
  <div class="modal" id="entryModal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-head">
        <h2 id="modalTitle">Gratitude</h2>
        <button class="modal-close" id="closeModal" aria-label="Close">√ó</button>
      </div>

      <div class="modal-body">
        <div class="section">
          <div class="section-title">üí° Need inspiration? Tap a prompt</div>
          <div class="prompts" id="promptList"></div>
        </div>

        <div class="section">
          <div class="section-title">What are you grateful for?</div>
          <textarea id="entryText" placeholder="Today I'm grateful for..."></textarea>
        </div>

        <div class="section">
          <div class="section-title">How are you feeling?</div>
          <div class="moods" id="moodSelector"></div>
        </div>

        <div class="section">
          <div class="section-title">Photo (optional)</div>
          <div class="photo-row">
            <div class="photo-actions">
              <button class="btn" id="choosePhotoBtn">üì∑ Choose photo</button>
              <button class="btn danger" id="removePhotoBtn" style="display:none;">Remove photo</button>
            </div>
            <input type="file" id="photoInput" accept="image/*" style="display:none;" />
            <img id="photoPreview" class="photo-preview" alt="Photo preview" />
          </div>
        </div>

        <div class="section">
          <button class="btn primary" id="saveEntry" style="width:100%;">Save entry</button>
          <button class="btn danger" id="deleteEntryBtn" style="width:100%; margin-top:10px; display:none;">üóëÔ∏è Delete entry</button>
        </div>
      </div>
    </div>
  </div>

  <button class="fab" id="fab" aria-label="Add entry">+</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    /*********************
     * App State & Routing
     *********************/
    let db;
    let currentDate = new Date();
    let currentView = 'home';
    let isDrawerOpen = false;
    let isModalOpen = false;
    let editingDate = null;
    let selectedMood = null;
    let selectedPhoto = null;
    let settings = { longestStreak: 0 };

    /*********************
     * Browser History (Hardware Back Button Support)
     *********************/
    function pushHistoryState(state) {
      // Prevents adding duplicate consecutive states
      const currentState = history.state || { view: 'home' };
      if (currentState.view === state.view && 
          currentState.drawer === state.drawer && 
          currentState.modal === state.modal) {
        return;
      }
      history.pushState(state, '', '');
    }

    window.addEventListener('popstate', (e) => {
      const state = e.state || { view: 'home', drawer: false, modal: false };

      if (isModalOpen && !state.modal) {
        closeEntryModal(true);
      } else if (isDrawerOpen && !state.drawer) {
        closeDrawer(true);
      } else {
        switchView(state.view, true);
      }
    });

    /*********************
     * Initialization & DB
     *********************/
    document.addEventListener('DOMContentLoaded', async () => {
      history.replaceState({ view: 'home', drawer: false, modal: false }, '', '');

      await initDB();
      loadSettings();
      initCalendarSwipe();

      // Drawer binds
      document.getElementById('menuBtn').addEventListener('click', () => openDrawer(false));
      document.getElementById('drawerClose').addEventListener('click', () => closeDrawer(false));
      document.getElementById('drawerBackdrop').addEventListener('click', () => closeDrawer(false));

      document.querySelectorAll('.drawer-nav button').forEach(btn => {
        btn.addEventListener('click', () => switchView(btn.dataset.view, false));
      });

      // Calendar Total Entries Card Link
      document.getElementById('totalEntriesCard').addEventListener('click', () => switchView('entries', false));

      // Calendar Nav
      document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
      document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));

      // Modal
      document.getElementById('fab').addEventListener('click', () => openEntryModal(new Date(), false));
      document.getElementById('closeModal').addEventListener('click', () => closeEntryModal(false));
      document.getElementById('entryModal').addEventListener('click', (e) => { 
        if (e.target.id === 'entryModal') closeEntryModal(false); 
      });

      document.getElementById('saveEntry').addEventListener('click', saveEntry);
      document.getElementById('deleteEntryBtn').addEventListener('click', deleteCurrentEntry);

      bindPhotoUpload();
      document.getElementById('searchBox').addEventListener('input', (e) => renderEntriesList(e.target.value || ''));
      document.getElementById('exportBtn').addEventListener('click', exportData);
      document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFile').click());
      document.getElementById('importFile').addEventListener('change', importData);

      await updateStats();
      await renderCalendar();
      renderMoodSelector();
      showOnThisDay();
    });

    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('gratitudeDiary', 1);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => { db = request.result; resolve(db); };
        request.onupgradeneeded = (e) => {
          db = e.target.result;
          if (!db.objectStoreNames.contains('entries')) {
            const store = db.createObjectStore('entries', { keyPath: 'date' });
            store.createIndex('favorite', 'favorite', { unique: false });
          }
        };
      });
    }

    function tx(storeName, mode = 'readonly') { return db.transaction([storeName], mode).objectStore(storeName); }
    function saveEntryToDB(e) { return new Promise((r, j) => { const req = tx('entries', 'readwrite').put(e); req.onsuccess = () => r(); req.onerror = () => j(req.error); }); }
    function getEntry(key) { return new Promise((r, j) => { const req = tx('entries').get(key); req.onsuccess = () => r(req.result); req.onerror = () => j(req.error); }); }
    function getAllEntries() { return new Promise((r, j) => { const req = tx('entries').getAll(); req.onsuccess = () => r(req.result || []); req.onerror = () => j(req.error); }); }
    function deleteEntry(key) { return new Promise((r, j) => { const req = tx('entries', 'readwrite').delete(key); req.onsuccess = () => r(); req.onerror = () => j(req.error); }); }

    /*********************
     * Navigation
     *********************/
    function switchView(viewName, isPopState = false) {
      if (!isPopState && currentView !== viewName) {
        pushHistoryState({ view: viewName, drawer: false, modal: false });
      }

      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(viewName).classList.add('active');
      currentView = viewName;

      document.querySelectorAll('.drawer-nav button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === viewName);
      });

      if (viewName === 'entries') renderEntriesList(document.getElementById('searchBox').value || '');
      if (viewName === 'stats') { updateStats(); showOnThisDay(); }

      if(isDrawerOpen) closeDrawer(true); // Don't push history when just closing drawer
    }

    function openDrawer(isPopState = false) {
      isDrawerOpen = true;
      document.getElementById('drawer').classList.add('open');
      document.getElementById('drawerBackdrop').classList.add('open');
      if (!isPopState) {
        pushHistoryState({ view: currentView, drawer: true, modal: false });
      }
    }

    function closeDrawer(isPopState = false) {
      isDrawerOpen = false;
      document.getElementById('drawer').classList.remove('open');
      document.getElementById('drawerBackdrop').classList.remove('open');
      if (!isPopState) {
        history.back(); // Trigger popstate to go back to clean view state
      }
    }

    /*********************
     * Calendar
     *********************/
    async function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      document.getElementById('currentMonth').textContent = new Date(year, month, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';

      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
        const h = document.createElement('div'); h.className = 'cal-head'; h.textContent = d; grid.appendChild(h);
      });

      const firstDow = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      for (let i = 0; i < firstDow; i++) {
        const blank = document.createElement('div'); blank.className = 'cal-day blank'; grid.appendChild(blank);
      }

      const entries = await getAllEntries();
      const byDate = new Map(entries.map(e => [e.date, e]));

      for (let day = 1; day <= daysInMonth; day++) {
        const d = new Date(year, month, day);
        const key = dateToKey(d);
        const entry = byDate.get(key);

        const cell = document.createElement('div'); cell.className = 'cal-day';
        if (isToday(d)) cell.classList.add('today');
        if (entry) cell.classList.add('has-entry');

        const top = document.createElement('div'); top.className = 'cal-day-top';
        const dn = document.createElement('div'); dn.className = 'day-num'; dn.textContent = day;
        const mood = document.createElement('div'); mood.className = 'mood'; mood.textContent = entry?.mood || '';
        top.appendChild(dn); top.appendChild(mood); cell.appendChild(top);

        if (entry?.photo) {
          const img = document.createElement('img'); img.className = 'thumb'; img.src = entry.photo; cell.appendChild(img);
        }
        if (entry?.text) {
          const snip = document.createElement('div'); snip.className = 'entry-snippet'; snip.textContent = entry.text; cell.appendChild(snip);
        }

        cell.addEventListener('click', () => openEntryModal(d, false));
        grid.appendChild(cell);
      }
    }

    function changeMonth(delta) { currentDate.setMonth(currentDate.getMonth() + delta); renderCalendar(); }

    /*********************
     * Modal Logic
     *********************/
    async function openEntryModal(dateObj, isPopState = false) {
      isModalOpen = true;
      if(!isPopState) pushHistoryState({ view: currentView, drawer: false, modal: true });

      editingDate = dateObj;
      const key = dateToKey(dateObj);
      document.getElementById('modalTitle').textContent = isToday(dateObj) ? "Today's Gratitude" : formatDateDisplay(dateObj);

      const container = document.getElementById('promptList');
      const picks = [...["A small win today", "A person you appreciate", "A moment of calm", "Something that made you smile"]].sort(() => Math.random() - 0.5).slice(0, 3);
      container.innerHTML = '';
      picks.forEach(p => {
        const el = document.createElement('div'); el.className = 'prompt'; el.textContent = p;
        el.addEventListener('click', () => {
          const ta = document.getElementById('entryText');
          if (!ta.value.trim()) ta.value = p + '...';
          ta.focus();
        });
        container.appendChild(el);
      });

      const entry = await getEntry(key);
      document.getElementById('entryText').value = entry?.text || '';
      selectedMood = entry?.mood || null;
      selectedPhoto = entry?.photo || null;
      updateMoodSelector();
      setPhotoPreview(selectedPhoto);
      document.getElementById('deleteEntryBtn').style.display = entry ? 'block' : 'none';
      document.getElementById('photoInput').value = '';

      document.getElementById('entryModal').classList.add('active');
    }

    function closeEntryModal(isPopState = false) {
      isModalOpen = false;
      document.getElementById('entryModal').classList.remove('active');
      if(!isPopState) history.back();
    }

    function setPhotoPreview(dataUrl) {
      const preview = document.getElementById('photoPreview');
      const removeBtn = document.getElementById('removePhotoBtn');
      if (dataUrl) { preview.src = dataUrl; preview.style.display = 'block'; removeBtn.style.display = 'inline-block'; } 
      else { preview.src = ''; preview.style.display = 'none'; removeBtn.style.display = 'none'; }
    }

    async function saveEntry() {
      const text = document.getElementById('entryText').value.trim();
      if (!text) return alert("Please write something.");
      const key = dateToKey(editingDate);
      const existing = await getEntry(key);
      await saveEntryToDB({ date: key, text, mood: selectedMood, photo: selectedPhoto, favorite: existing?.favorite || false, timestamp: Date.now() });
      closeEntryModal(false);
      await updateStats(); await renderCalendar();
      if (currentView === 'entries') renderEntriesList(document.getElementById('searchBox').value || '');
    }

    async function deleteCurrentEntry() {
      if (!confirm('Delete this entry?')) return;
      await deleteEntry(dateToKey(editingDate));
      closeEntryModal(false);
      await updateStats(); await renderCalendar();
      if (currentView === 'entries') renderEntriesList(document.getElementById('searchBox').value || '');
    }

    /*********************
     * Helpers & Others
     *********************/
    const pad2 = n => String(n).padStart(2, '0');
    function dateToKey(d) { return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`; }
    function keyToDate(k) { const [y, m, d] = k.split('-'); return new Date(y, m - 1, d); }
    function formatDateDisplay(d) { return d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
    function isToday(d) { const t = new Date(); return d.getFullYear() === t.getFullYear() && d.getMonth() === t.getMonth() && d.getDate() === t.getDate(); }

    function renderMoodSelector() {
      const container = document.getElementById('moodSelector');
      [{e:'üòä',n:'Joy'},{e:'üå±',n:'Peace'},{e:'üí™',n:'Accomplished'},{e:'‚ù§Ô∏è',n:'Love'},{e:'üåü',n:'Inspired'}].forEach(m => {
        const btn = document.createElement('button'); btn.className = 'mood-btn'; btn.textContent = m.e;
        btn.addEventListener('click', () => { selectedMood = m.e; updateMoodSelector(); });
        container.appendChild(btn);
      });
    }

    function updateMoodSelector() { document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.toggle('selected', btn.textContent === selectedMood)); }

    function bindPhotoUpload() {
      document.getElementById('choosePhotoBtn').addEventListener('click', () => document.getElementById('photoInput').click());
      document.getElementById('photoInput').addEventListener('change', e => {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader(); r.onload = () => { selectedPhoto = r.result; setPhotoPreview(selectedPhoto); }; r.readAsDataURL(f);
      });
      document.getElementById('removePhotoBtn').addEventListener('click', () => { selectedPhoto = null; setPhotoPreview(null); });
    }

    function loadSettings() { const saved = localStorage.getItem('gratitudeSettings'); if (saved) settings = { ...settings, ...JSON.parse(saved) }; }
    function saveSettings() { localStorage.setItem('gratitudeSettings', JSON.stringify(settings)); }

    async function updateStats() {
      const entries = await getAllEntries();
      const keys = new Set(entries.map(e => e.date));
      let current = 0, longest = 1, run = 1;

      const tk = dateToKey(new Date()); 
      const y = new Date(); y.setDate(y.getDate()-1); const yk = dateToKey(y);
      if(keys.has(tk) || keys.has(yk)) {
        current = 1; let cur = keys.has(tk) ? new Date() : y;
        for(let i=1; i<3650; i++) { cur.setDate(cur.getDate()-1); if(keys.has(dateToKey(cur))) current++; else break; }
      }

      const sorted = Array.from(keys).sort();
      for(let i=1; i<sorted.length; i++) {
        if(Math.round((keyToDate(sorted[i]) - keyToDate(sorted[i-1])) / 86400000) === 1) { run++; if(run > longest) longest = run; } else run = 1;
      }

      if(longest > (settings.longestStreak || 0)) { settings.longestStreak = longest; saveSettings(); }

      document.getElementById('currentStreak').textContent = current;
      document.getElementById('drawerStreak').textContent = current;
      document.getElementById('totalEntries').textContent = entries.length;
      document.getElementById('drawerTotal').textContent = entries.length;
      document.getElementById('longestStreak').textContent = settings.longestStreak || 0;
      document.getElementById('photoCount').textContent = entries.filter(e => !!e.photo).length;
      document.getElementById('favoritesCount').textContent = entries.filter(e => !!e.favorite).length;
      document.getElementById('thisMonthEntries').textContent = entries.filter(e => keyToDate(e.date).getMonth() === new Date().getMonth()).length;
    }

    async function renderEntriesList(term) {
      const container = document.getElementById('entriesList');
      let list = (await getAllEntries()).sort((a,b) => keyToDate(b.date) - keyToDate(a.date));
      if(term) list = list.filter(e => (e.text||'').toLowerCase().includes(term.toLowerCase()));

      container.innerHTML = list.length ? '' : '<div class="empty">üìî No entries found.</div>';
      list.forEach(e => {
        const c = document.createElement('div'); c.className = 'entry-card';
        c.innerHTML = `<div class="entry-head"><div class="entry-date">${e.mood||'‚ú®'} ${formatDateDisplay(keyToDate(e.date))}</div></div>
                       <div class="entry-text">${e.text||''}</div>`;
        if(e.photo) c.innerHTML += `<img class="entry-photo" src="${e.photo}">`;
        container.appendChild(c);
      });
    }

    async function showOnThisDay() {
      const list = await getAllEntries(); const t = new Date();
      const m = list.filter(e => { const d = keyToDate(e.date); return d.getDate()===t.getDate() && d.getMonth()===t.getMonth() && d.getFullYear()!==t.getFullYear(); });
      document.getElementById('onThisDay').innerHTML = m.length ? m.slice(0,3).map(e => `<div style="padding:10px 0;border-top:1px solid var(--border)"><div style="font-weight:900">${e.mood||'‚ú®'} ${formatDateDisplay(keyToDate(e.date))}</div><div style="color:var(--muted);margin-top:6px">${e.text}</div></div>`).join('') : 'No entries from previous years.';
    }

    async function exportData() {
      const entries = await getAllEntries(); const zip = new JSZip();
      zip.file('gratitude_data.json', JSON.stringify(entries.map(e => ({date: e.date, text: e.text, mood: e.mood, favorite: !!e.favorite, hasPhoto: !!e.photo})), null, 2));
      const pf = zip.folder('photos');
      entries.forEach(e => { if(e.photo) pf.file(`${e.date}.jpg`, e.photo.split(',')[1], {base64: true}); });
      const blob = await zip.generateAsync({type:'blob'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `gratitude_${dateToKey(new Date())}.zip`; a.click();
    }

    async function importData(e) {
      const f = e.target.files[0]; if(!f || !confirm('Merge entries?')) return;
      const zip = await JSZip.loadAsync(f);
      const entries = JSON.parse(await zip.file('gratitude_data.json').async('string'));
      const photos = zip.folder('photos');
      for(const e of entries) {
        let photo = null;
        if(e.hasPhoto && photos.file(`${e.date}.jpg`)) photo = `data:image/jpeg;base64,${await photos.file(`${e.date}.jpg`).async('base64')}`;
        await saveEntryToDB({date: e.date, text: e.text, mood: e.mood, favorite: e.favorite, photo, timestamp: Date.now()});
      }
      alert('Imported.'); location.reload();
    }

    function initCalendarSwipe() {
      const shell = document.getElementById('calendarShell');
      const grid = document.getElementById('calendarGrid');
      let startX = 0, currentX = 0;
      const threshold = 50; // Minimum pixels to count as a deliberate swipe

      // 1. Record starting position when user touches the screen
      shell.addEventListener('touchstart', e => {
        startX = e.touches[0].clientX;
        grid.style.transition = 'none'; // Disable transition so grid follows finger instantly
      }, {passive: true});

      // 2. Track movement and move the grid slightly to give visual feedback
      shell.addEventListener('touchmove', e => {
        if(!startX) return;
        currentX = e.touches[0].clientX - startX;
        // Move the grid slightly with the finger (0.4 multiplier creates resistance)
        grid.style.transform = `translateX(${currentX * 0.4}px)`;
      }, {passive: true});

      // 3. Determine if swipe was far enough when user lifts finger
      shell.addEventListener('touchend', e => {
        if(!startX) return;
        
        // Re-enable smooth transitions
        grid.style.transition = 'transform 0.25s ease-out, opacity 0.2s ease-out';
        
        if (currentX > threshold) {
          // Swiped Right -> Previous Month
          grid.style.transform = 'translateX(30px)'; // Slide out right
          grid.style.opacity = '0'; // Fade out
          setTimeout(() => { 
            changeMonth(-1); // Change data
            grid.style.transform = 'translateX(-30px)'; // Reset to left side invisibly
            setTimeout(() => { 
              grid.style.transform = 'translateX(0)'; // Slide in to center
              grid.style.opacity = '1'; // Fade in
            }, 50); 
          }, 200);
          
        } else if (currentX < -threshold) {
          // Swiped Left -> Next Month
          grid.style.transform = 'translateX(-30px)'; // Slide out left
          grid.style.opacity = '0'; // Fade out
          setTimeout(() => { 
            changeMonth(1); // Change data
            grid.style.transform = 'translateX(30px)'; // Reset to right side invisibly
            setTimeout(() => { 
              grid.style.transform = 'translateX(0)'; // Slide in to center
              grid.style.opacity = '1'; // Fade in
            }, 50); 
          }, 200);
          
        } else {
          // Swipe was too short -> Snap back to center
          grid.style.transform = 'translateX(0)';
          grid.style.opacity = '1';
        }
        
        // Reset variables for next swipe
        startX = 0; currentX = 0;
      });
    }

  </script>
</body>
</html>
